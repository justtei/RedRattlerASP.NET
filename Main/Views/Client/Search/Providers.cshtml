@using MSLivingChoices.Entities.Client.Search.Criteria
@using MSLivingChoices.Mvc.Uipc.Client.Enums
@using MSLivingChoices.Mvc.Uipc.Client.Helpers
@using MSLivingChoices.Mvc.Uipc.Client.ViewModels
@using MSLivingChoices.Mvc.Uipc.Enums
@using MSLivingChoices.Utilities
@model ServiceProvidersSearchVm

@{
    Layout = "~/Views/Client/Shared/_SearchResultLayout.cshtml";
}
<style>
    .refine {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .refine li {
        font-weight: 700;
    }
</style>

@section scripts
{
    <script type="text/html" id="qv-widget">
        <section class="quick"
                    data-bind="slideVisible: isShow">
            <div class="container"
                    data-bind="template: { name: tab().template, data: tab().model, afterRender: tab().afterRender }">
            </div>
            <div class="control txt-center">
                <button class="btn btn-close"
                        data-bind="click: hide">
                    Close
                    <i class="icon-arrow-top"></i>
                </button>
            </div>
        </section>
    </script>

    <script type="text/javascript">
        mslc.resolve(['client/widgets/qvInitializer'], function(initQv) {
            initQv(@((int) Model.PageType.ToSearchType()), 'serviceProviderId');
        }, 'init-qv');

        mslc.resolve(['client/widgets/leadForm'], function(leadForm) {
            leadForm.initPopUpSharedData(@Html.Json(Model.LeadForm));
        }, 'init-lead-form');

        mslc.resolve(['client/widgets/googlePublisherTag'], function(gpt) {
            gpt.initSearchResultsSlots({
                country: '@Model.Criteria.CountryCode()',
                state: '@Model.Criteria.StateCode()',
                city: '@Model.Criteria.City()'
            });
        }, 'init-gpt');

        mslc.resolve(['client/analytics/google'], function(ga) {
            ga.trackPageView(@Html.Json(Model.Dimensions));
        }, 'ga-tracking');

        mslc.resolve(['client/ui/hintsManager'], function() {
        }, 'init-hints');

        mslc.resolve([
            'lib/ko'
            , 'client/widgets/refine'
            , 'client/widgets/refine/pas'
        ], function(ko, Refine, Pas) {
            var refine = new Refine(@Html.Json(Model), Pas);
            ko.applyBindings(refine, document.getElementById("refine"));
            ko.applyBindings(refine, document.getElementById("sort"));
        }, 'init-refine');
    </script>
}
<div class="row">
    <div class="col-md-12">
        @if (!Model.Result.Any())
        {
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 col-md-6 mb-3">
                        <img alt="No results" style="width: 100%;" src="~/Content/images/stub/no-result.png" />
                    </div>
                    <span class="col-lg-6 col-md-6 mb-3 text-justify d-flex align-items-center">
                        We could not find any listings in this area or your search filters may be too strict. Please try to clear all filters or
                        search for nearby locations with listings. Our information is updated daily so please check back soon.
                    </span>
                </div>
            </div>
        }

        @if (Model.Result.Any())
        {
            <section class="space-ptb bg-light">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="sidebar">
                                <div class="widget mb-3">
                                    @if (Model.DisplayProperties.BookOrder)
                                    {
                                        Html.RenderPartial("~/Views/Client/Search/Partial/Order.cshtml");
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-9">
                            <div class="row mb-2">
                                <div class="col-lg-12">
                                    <div class="property-filter d-md-flex d-block">
                                        <div class="d-md-flex d-block mb-0">
                                            <h2>Product and Service Listing</h2>
                                        </div>
                                        <div class="property-view-list d-md-flex d-block mb-0 mt-4 mt-sm-0">
                                            <a class="btn btn-outline mt-md-0 mt-2" href="javascript:;" onclick="listShow()"><i class="fa fa-list mr-1"></i> List View</a>
                                            <a class="btn btn-outline mt-md-0 mt-2 ml-sm-2 ml-0" href="javascript:;" onclick="mapShow()"><i class="fas fa-map-marker-alt mr-1"></i> Map View</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3 mb-2">
                                <div class="col-md-12">
                                    @switch (Model.PageType.ToRefineType())
                                    {
                                        case RefineType.SeniorHousing:
                                            {
                                                Html.RenderPartial("~/Views/Client/Search/Partial/Refine/Shc.cshtml");
                                                break;
                                            }
                                        case RefineType.ActiveCommunity:
                                        case RefineType.ActiveHome:
                                            {
                                                Html.RenderPartial("~/Views/Client/Search/Partial/Refine/AacAah.cshtml");
                                                break;
                                            }
                                        case RefineType.Service:
                                            {
                                                Html.RenderPartial("~/Views/Client/Search/Partial/Refine/Pas.cshtml");
                                                break;
                                            }
                                    }
                                </div>
                            </div>
                            <div class="map-container" style="display: none;">
                                <div id="map" style="width:100%; height: 30em;"></div>
                            </div>
                            <div id="list_view">
                                @foreach (var provider in Model.Result)
                                {
                                    <div class="row">
                                        <div class="col-lg-12 mb-4">
                                            <div class="property-list bg-white">
                                                <div class="row no-gutters">
                                                    <div class="col-md-5">
                                                        <div class="property-image h-100 bg-overlay-gradient-04">
                                                            @if (provider.DisplayProperties.Image)
                                                            {
                                                                <div class="img-bg">
                                                                    @RenderHelper.ThumbnailWithMicrodata(provider.Image, "img-fluid")
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="col-md-7">
                                                        <div class="property-detail p-4">
                                                            <h3 class="property-title mb-1"><a href="@provider.DetailsUrl">@(provider.DisplayProperties.Name ? provider.Name : "View details")</a></h3>
                                                            <ul class="pl-0 mb-1">
                                                                <li class="property-address mb-1">
                                                                    @if (provider.DisplayProperties.Address)
                                                                    {
                                                                        <i class="fas fa-map-marker-alt fa-1x mr-1 text-primary"></i> <span>EXACT -</span><span>provider.Address.City, @provider.Address.StateCode @provider.Address.Zip</span>
                                                                    }
                                                                </li>
                                                                <li class="property-address mb-1">
                                                                    @if (provider.DisplayProperties.Phone)
                                                                    {
                                                                        <i class="fas fa-phone-alt fa-1x text-primary mr-1"></i>
                                                                        @provider.Phone
                                                                    }
                                                                </li>
                                                            </ul>
                                                            <p class="mb-1">
                                                                <address class="ind-s" itemprop="address" itemscope itemtype="http://schema.org/PostalAddress">
                                                                    <span class="address-line">
                                                                        <span itemprop="streetAddress">@provider.Address.Line</span>
                                                                        @if (provider.DisplayProperties.RadiusDesignation)
                                                                        {
                                                                            <span class="txt-lower txt-decr txt-brand-blue txt-bold radius-designation"
                                                                                  data-hint="#radius-designation-hint">@provider.SearchRadiusDesignation</span>
                                                                            }
                                                                    </span>
                                                                    <br />
                                                                    <span class="city" itemprop="addressLocality">@provider.Address.City</span>
                                                                    <span class="state" itemprop="addressRegion">@provider.Address.StateCode</span>
                                                                    <span itemprop="postalCode">@provider.Address.Zip</span>
                                                                </address>
                                                            </p>
                                                            <div class="mb-3">
                                                                <a href="@provider.DetailsUrl" class="font-weight-bold">Read More <i class="fas fa-angle-right"></i></a>
                                                            </div>
                                                            <a class="btn btn-outline btn-sm mb-1 mr-2 ml-0 mt-1" href="@provider.DetailsUrl">View Profile</a>
                                                            @if (provider.DisplayProperties.LeadForm)
                                                            {
                                                                <button class="btn btn-primary btn-sm ml-0"
                                                                        data-toggle="lead-form"
                                                                        data-accessor="attr"
                                                                        data-listing-id="@provider.Id"
                                                                        data-listing-name="@provider.Name"
                                                                        data-message="@provider.GetLeadFormMessage()">
                                                                    Request Information
                                                                </button>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            <ul class="pagination mt-4 mb-0">
                                @foreach (var page in Model.Paging.Pages)
                                {
                                    if (page.Css == "prev")
                                    {
                                        <li class="page-item active"><a class="page-link" href="@page.Href">Previous</a></li>
                                    }
                                    if (page.InnerText == "1" || page.InnerText == "2" || page.InnerText == "3")
                                    {
                                        <li class="page-item @page.Css"><a class="page-link" href="@page.Href">@page.InnerText</a></li>
                                    }
                                    if (page.Css == "next")
                                    {
                                        <li class="page-item active"><a class="page-link" href="@page.Href">Next</a></li>
                                    }
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        }
    </div>
</div>
<script>
     console.log(@Html.Json(Model.Result));
    function GoLikeIt(div) {
        var Ndiv = div.nextElementSibling;

        if (Ndiv.style.height != '0px') {
            Ndiv.style.height = '0px';
        }
        else {
            Ndiv.style.height = 'fit-content';
        }
    }

    function listShow() {
        $(".map-container").css("display", "none");
        $("#list_view").css("display", "initial");
    }

    function mapShow() {
        $(".map-container").css("display", "initial");
        $("#list_view").css("display", "none");
        var communities = @Html.Json(Model.Result);
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: new google.maps.LatLng(communities[0]["address"]["latitude"], communities[0]["address"]["longitude"]),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        var infowindow = new google.maps.InfoWindow();
        var marker, i;
        for (i = 0; i < communities.length; i++) {
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(communities[i]["address"]["latitude"], communities[i]["address"]["longitude"]),
                map: map
            });
            google.maps.event.addListener(marker, 'click', (function (marker, i) {
                return function () {
                    var str = `<div class="card" style="width: 14rem;">
                                  <img class="card-img-top" src="`+ communities[i]['image']['thumbnailSrc']+`" alt="thumbnail">
                                  <div class="card-body p-1">
                                    <p class="card-title m-0"><a href="`+ communities[i]['detailsUrl'] + `">` + communities[i]['name'] +`</a></p>
                                    <p class="property-address m-0"><i class="fas fa-map-marker-alt fa-1x mr-1 text-secondary"></i>`+ communities[i]['address']['city'] + `,` + communities[i]['address']['stateCode'] + `</p>
                                    <p class="property-address m-0"><i class="fas fa-building fa-1x text-secondary mr-1"></i>55+ Community  •  Apartments</p>
                                    <p class="property-address m-0"><i class="fas fa-phone-alt text-secondary mr-1"></i>`+ communities[i]['phone'] + `</p>
                                  </div>
                                </div>`
                    infowindow.setContent(str);
                    infowindow.open(map, marker);
                }
            })(marker, i));
        }
    }
</script>
